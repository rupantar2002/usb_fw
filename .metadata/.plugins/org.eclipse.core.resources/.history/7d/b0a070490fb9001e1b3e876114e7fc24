#include "usbd_driver.h"


void initialize_gpio_pins(void){

	// Enable clock for GPIOA
	SET_BIT(RCC->AHB1ENR,RCC_AHB1ENR_GPIOAEN);

	// set alternate function of PA12(D+) and PA11(D-)
	MODIFY_REG(GPIOA->AFR[1],
			GPIO_AFRH_AFRH11|GPIO_AFRH_AFRH11,
			_FLD2VAL(GPIO_AFRH_AFRH11,0xC)|_FLD2VAL(GPIO_AFRH_AFRH11,0xC));

	// Configure pins to work in USB mode
	MODIFY_REG(GPIOA->MODER,
			GPIO_MODER_MODE11|GPIO_MODER_MODE12,
			_VAL2FLD(GPIO_MODER_MODE11,0x2)|_VAL2FLD(GPIO_MODER_MODE12,0X2));
}

void initialize_usb_core(void){

	// Enable the clock of USB core
	SET_BIT(RCC->AHB1ENR,RCC_AHB1ENR_OTGHSEN);

	// Configure USB to device mode
	USB_OTG_HS->GUSBCFG
	MODIFY_REG(USB_OTG_HS->GUSBCFG,
			USB_OTG_GUSBCFG_FDMOD | USB_OTG_GUSBCFG_PHYSEL | USB_OTG_GUSBCFG_TRDT,
			 USB_OTG_GUSBCFG_FDMOD | USB_OTG_GUSBCFG_PHYSEL | _VAL2FLD( USB_OTG_GUSBCFG_TRDT,0x9)
			);

}

